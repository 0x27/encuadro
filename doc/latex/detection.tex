\chapter{Detección}
\label{ch:detection}
Hola

\section{Típos de características}
Intro y mas breves definiciones?. 

Bordes, esquinas, líneas, segmentos de línea, regiones (blobs). 

\section{Bordes y esquinas}
	\subsection{Detector de bordes de Canny}
	\subsection{Detector de bordes y esquinas de Harris}
	\subsection{SUSAN Y FAST}

\section{Líneas y segmentos de línea}
	\subsection{Detector de líneas de Hough}
	\subsection{Detector de segmentos de línea: LSD}

\section{Regiones y puntos de interés}
	\subsection{FAST}		
	\subsection{Blobs}

%\subsection{Cilindros y esferas}
%\subsubsection{Algortimos de cilindros y esferas}

\section{Detección sin primitivas markerless}
SIFT (puntero a capitulo que tiene SIFT para reconocimiento)
SURF, ETC ETC.

\section{Marcadores}
\label{sec:marcadores}
Marcadores que se usan.
Limitaciones

La inclusión de \emph{marcadores}, \emph{marcas de referencia} o \emph{fiduciales}, en inglés \emph{markers}, \emph{landmarks} o \emph{fiducials}, en la escena ayuda al problema de extracción de características y por lo tanto al problema de estimación de pose \cite{Lepetit05b}. Estos por construcción son elementos que presentan una detección estable en la imagen para el tipo de característica que se desea extraer así como medidas facilmente utilizables para la estimación de la pose.

Se distinguen dos tipos de \emph{fiduciales}. El primer tipo son los que se llaman puntos \emph{fiduciales} por que proveen una correspondencia de puntos entre la escena y la imagen. El segundo tipo, \emph{fiduciales planares}, se pueden obtener mediante la construcción en una geometría coplanar de una serie de \emph{puntos fiduciales} identificables como esquinas. Un único \emph{fiducial planar} puede contener por si solo todas las seis restricciones espaciales necesarias para definir el marco de coordenadas. 

Como se explica en la sección \ref{ch:camaraypose} el problema de estimación de pose requiere de una serie de correspondencias $\mathbf{M}_i\leftrightarrow \mathbf{m}_i$ entre puntos 3D en la escena en coordenadas del mundo y puntos en la imagen.

\section{Marcador QR}
El enfoque inicial elegido para la detección de \emph{puntos fiduciales} para marcadores parte del trabajo de fin de curso de Matías Tailanian para el curso \emph{Tratamiento de imágenes por computadora} de Facultad de Ingeniería, Universidad de la Republica\footnote{Autoposicionamiento 3D -  http://sites.google.com/site/autoposicionamiento3d/}. La elección se basa principalmente en los buenos resultados obtenidos para dicho trabajo con un enfoque relativamente simple. El trabajo desarrolla, entre otras cosas, un diseño de marcador y un sistema de detección de marcadores basado en el detector de segmentos LSD\cite{grompone10} por su buena performance y aparente bajo costo computacional. 

El marcador utilizado está basado en la estructura de detección incluida en los códigos \emph{QR} y se muestra en la figura \ref{fig:Marker}. Éste consiste en trés grupos idénticos de tres cuadrados concéntricos superpuestos de tal forma que los lados de cada uno de trés cuadrados son visualizables. A diferencia de los códigos \emph{QR} la disposición de los grupos de cuadrados es distinto para evitar ambiguedades en la determinación  de su posicionamiento espacial. Estas dos características son escenciales para la extracción de los \emph{puntos fiduciales} de forma coherente, es decir, las correspondencias tienen que poder ser determinadas completamente bajo criterios razonables.
\begin{figure}[h!]
\centering
\includegraphics[scale=0.3]{figs_detection/Marker.eps}
\caption{Marcador propuesto basado en la estructura de detección de códigos QR.}
\label{fig:Marker}
\end{figure}

\subsection{Estructura del marcador}
\label{sec:detection_estructuras}
A continuación se presentan algunas definiciones de las estructuras básicas que constituyen el marcador propuesto. Estas son de utilidad para el diseño y forman un flujo natural y escalable para el desarrollo del algoritmo de determinación de correspondencias.\\

Los elementos mas básicos en la estructura son los \emph{segmentos} los cuales consisten en un par de puntos en la imagen, $\mathbf{p} = (p_x,p_y)$ y $\mathbf{q} = (q_x,q_y)$. Estos \emph{segmentos} forman lo que son los lados del \emph{cuadrilátero}, el próximo elemento estructural del marcador.\\

Un \emph{cuadrilátero} o \emph{quadrilateral} en inglés, al que se le denomina $\text{Ql}$, está determinado por cuatro segmentos conexos y distintos entre sí. El cuadrilátero tiene dos propiedades notables; el \emph{centro} definido como el punto medio entre sus cuatro vértices y el \emph{perímetro} definido como la suma de el largo de sus cuatro lados. Los \emph{vértices} de un \emph{cuadrilátero} se determinan mediante la intersección, en sentido amplio, de dos segmentos contiguos. Es decir, si $s_1$ es contiguo a $s_2$ dadas las recta $r_1$ que pasa por los puntos $\mathbf{p}_1$, $\mathbf{q}_1$ del segmento $s_1$ y la recta $r_2$ que pasa por los puntos $\mathbf{p}_2$, $\mathbf{q}_2$ del segmento $s_2$, se determina el vértice correspondiente como la intersección $r_1 \cap r_2$. \\
%La propiedad de conexión entre dos segmentos se relaja a la intersección de dos discos de un cierto radio en torno a los puntos de dos segmentos vecinos. \\

A un \emph{conjunto de cuadriláteros} o \emph{quadrilateral set} se le denomina $\text{QlSet}$, se construye a partir de $\text{M}$ cuadriláteros, que comparten un mismo centro, y se diferencian por un factor de escala, con $\text{M}>1$. A partir de dichos cuadriláteros se construye un lista ordenada $(\text{Ql}[0],\text{Ql}[1],\dots,\text{Ql}[\text{M}-1])$ en donde el orden viene dado por el valor de \emph{perímetro} de cada \text{Ql}. Se define el \emph{centro del grupo de cuadriláteros} como el promedio de los centros de cada $\text{Ql}$ de la lista ordenada.\\

Finalmente el \emph{marcador QR} está constituido por $\text{N}$ \emph{conjuntos de cuadriláteros} dispuestos en una geometría particular. Esta geometría permite la determinación un sistema de coordenadas; un origen y dos ejes a utilizar. Se tiene una lista ordenada  $(\text{QlSet}[0],\text{QlSet}[1],\dots,\text{QlSet}[\text{N}-1])$ en donde el orden se puede determinar mediante la geometría de los mismos o a partir de hipótesis razonables.\\

Un marcador proveerá un numero de $\text{4}\times\text{M}\times\text{N}$ vértices y por lo tanto la misma cantidad de puntos fiduciales para proveer las correspondencias  $\mathbf{M}_i\leftrightarrow \mathbf{m}_i$ al algoritmo de estimación de pose.\\

\subsection{Diseño}
En base a las estructuras previamente definidas es que se describe el diseño del marcador. Como ya se explicó se toma un marcador tipo \emph{QR} basado en \emph{cuadriláteros} y mas específicamente en tres conjuntos de tres cuadrados dispuestos en como se muestra en la figura \ref{fig:Marker}.\\

Los tres \emph{cuadriláteros} correspondientes a un mismo \emph{conjunto de cuadriláteros} tienen idéntica alineación e idéntico centro. Los diferencia un factor de escala, esto es, $\text{Ql}[0]$ tiene lado $l$ mientras que $\text{Ql}[1]$ y $\text{Ql}[2]$ tienen lado $2l$ y $3l$ respectivamente. Esto se puede ver en la figura \ref{fig:QlSetDetail}. Adicionalmente se define un sistema de coordenadas con centro en el centro del $\text{QlSet}$ y ejes definidos como $\textbf{x}$ horizontal a la derecha e $\textbf{y}$ vertical hacia abajo. Esta convención en las direcciones de los ejes es muy utilizada en el ambiente del \emph{tratamiento de imágenes} para definir las direcciones de los ejes de una imagen. Definido el sistema de coordenadas de puede fijar un orden a los \emph{vértices} $v_{j_{1}}$ de cada \emph{cuadrilátero} $\text{Ql}[\text{j}]$ como, \\
\begin{align*}
v_{j_{0}} = (a/2,a/2) && v_{j_{2}} = (-a/2,-a/2)  \\
v_{j_{1}} = (a/2,-a/2)&& v_{j_{3}} = (-a/2,a/2)
\end{align*}
con $a=(j+1)\times l$. El orden aquí explicado se puede ver también junto con el sistema de coordenadas en la figura \ref{fig:MarkerDetail}.\\
\begin{figure}[h!]
\centering
\includegraphics[scale=0.35]{figs_detection/QlSetDetail.eps}
\caption{Detalle de un QlSet. Orden de los \emph{cuadriláteros} a la izquiera. Órden de los \emph{vértices} a la derecha.}
\label{fig:QlSetDetail}
\end{figure}

Un detalle del marcador completo se muestra en la figura \ref{fig:MarkerDetail} en donde se define el conjunto $\text{i}$ de cuadriláteros concéntricos como el $\text{QlSet}[\text{i}]$ y se definen los respectivos centros $\mathbf{c}_i$ para cada $\text{QlSet}[\text{i}]$. El sistema de coordenadas del \emph{marcador QR} tiene centro en el centro del $\text{QlSet}[0]$ y ejes de coordenadas idénticos al definido para cada $\text{Ql}$. Se tiene además que los ejes de coordenadas pueden ser obtenidos mediante los vectores normalizados,
\begin{equation}
\begin{split}
\mathbf{x}  = \frac{\mathbf{c}_1 - \mathbf{c}_0}{||\mathbf{c}_1-\mathbf{c}_0||} & \quad
\mathbf{y}  = \frac{\mathbf{c}_2 - \mathbf{c}_0}{||\mathbf{c}_2-\mathbf{c}_0||}
\end{split} 
\label{ec:detection_ejes}
\end{equation}

La disposición de los $\text{QlSet}$ es tal que la distancia indicada $d_{01}$ definida como la norma del vector entre los centros $\mathbf{c}_1$ y $\mathbf{c}_0$ es significativamente mayor que la distancia $d_{02}$ definida como la norma del vector entre los centros $\mathbf{c}_2$ y $\mathbf{c}_1$. Esto es, $d_{01}\gg d_{02}$. Este criterio facilita la identificación de los \emph{vértices} de los $\text{QlSet}$ entre sí basados únicamente en la posición de sus centros y se explicará en la parte de determinación de correspondencias (sec.: \ref{subsec:detection_correspondencias}).
\begin{figure}[h!]
\centering
\includegraphics[scale=0.3]{figs_detection/MarkerDetail.eps}
\caption{Detalle del marcador propuesto formando un sistema de coordenadas.}
\label{fig:MarkerDetail}
\end{figure}


\subsubsection{Parámetros de diseño}
Provisto el diseño del marcador antes descrito, quedan definidos ciertos parámetros \textbf{estructurales} que fueron de tomados fijos a lo largo del proyecto pero que podrían se variados en trabajos futuros asociados. Estos parámetros son:
\begin{itemize}
\item M: cantidad de \emph{conjuntos de cuadriláteros}.
\item N: cantidad de \emph{cuadriláteros} por \emph{conjuntos de cuadriláteros}.
\item Geometría: geometría de los cuadriláteros (Ql).
\item Disposición: disposición espacial de los \emph{conjuntos de cuadriláteros} (QlSet).
\end{itemize}

El criterio de elección de M y N parte del diseño los códigos QR como ya fue explicado. La detección por segmentos de línea resulta una cantidad de $3\times \text{QlSet}$'s conteniendo $3 \times \text{Ql}$'s cada uno. Bajo esta elección de parámetros se tienen $36$ \emph{segmentos} y \emph{vértices}. Se tienen entonces un número de puntos característicos razonable para la estimación de pose.

La elección de \emph{cuadrados} como parámetro de geometría se basa en la necesidad de tener igual resolución en los dos ejes del marcador. De esta forma se asegura una distancia límite en donde, en un caso ideal enfrentado al marcador, la detección de segmentos de línea falla simultaneamente en los segmentos verticales como en los horitonzales. De otra forma se tendría una dirección que limita mas que la otra desaprovechando resolución.

La disposición espacial de los \emph{conjuntos de cuadriláteros} esta en primer lugar limitada a un plano y en segundo lugar es tal que se puede definir ejes de coordenadas ortogonales mediante los centros.\\

Por otro lado se tiene otro juego de parámetros que concluyen con el diseño del marcador. Estos parámetros conservan la estructura intrínseca del marcador permitiendo versatilidad en la aplicación y sin la necesidad de modificación alguna de los algoritmos desarrollados. Estos son:
\begin{itemize}
\item $d_{ij}$: distancia entre los \emph{centros} $\text{QlSet}[j]$ con $\text{QlSet}[i]$.
\item $l$: lado del \emph{cuadrilátero} mas pequeño ($\text{Ql}[0]$) de los $\text{QlSet}$.
\end{itemize}

En este caso se debe siempre cumplir la condición impuesta previamente en donde $d_{01}\gg d_{02}$. De otra forma se deberán realizar ciertas hipótesis no genéricas o se deberá aumentar ligeramente la complejidad del algoritmo para la identificación del marcador.\\

\subsubsection{Diseño \emph{test}}
Durante el desarrollo de los algoritmos de detección e identificación de los \emph{vértices} del \emph{marcador QR} se trabajó con determinados parámetros de diseño de dimensiones apropiadas para posibilitar el traslado y las pruebas domésticas. 

\subsubsection{Diseño \emph{Da Vinci}}

\subsubsection{Diseño \emph{Artigas}}

\subsubsection{Diseño \emph{Mapa}}

\subsection{Detección}
La etapa de detección del marcador se puede separar en tres grandes bloques; la detección de segmentos de línea, el filtrado de segmentos y la determinación de correspondencias (figura \ref{fig:detección_diagrama_marcador}).

\subsubsection{Detección de segmentos de línea}
La detección de segmentos de línea se realiza mediante el uso del algoritmo \emph{LSD} el cual se detalla en el capítulo \ref{ch:lsd}. En forma resumida, dicho algoritmo toma como entrada una imagen en escala de grises de tamaño $m\times n$ y devuelve una lista de segmentos en forma de pares de puntos de origen y destino.
\begin{itemize}
\item[]
\begin{verbatim}
int nb;
double *img;
...
out = lsd(&nb,img,m,n);
\end{verbatim}
\end{itemize}

\subsubsection{Filtrado de segmentos}
El filtrado de segmentos consiste en la búsqueda de conjuntos de cuatro segmentos conexos en la lísta de segmentos de línea detectados por \emph{LSD}. Los conjuntos de segmentos conexos encontrados se devuelven en una lista similar a la de \emph{LSD}. A continuación se realiza una breve descripción del algoritmo de filtrado de segmentos implementado.\\

Se parte de una lista de $m$ segmentos de línea,
\begin{equation}
 \mathbf{L} = \begin{pmatrix}
               \mathbf{s}_0 & \mathbf{s}_1 & \dots & \mathbf{s}_{m-1} 
              \end{pmatrix}^t
\end{equation}
y se recorre en $i$ en busca de segmentos vecinos.

La estrategia utilizada consiste en buscar, para el $i$-ésimo segmento $\mathbf{s}_i$, dos segmentos vecinos, en primero lugar $\mathbf{s}_j$ y en segundo lugar $\mathbf{s}_k$, de forma que se forme una ``U'' como se muestra en la figura \ref{fig:SegmentosRectas}. La tercer etapa de búsqueda consiste en completar ese conjunto con un cuarto segmento $\mathbf{s}_l$ que cierre la ``U''.

Dos segmentos son vecinos si se cumple que la distancia euclidiana entre puntos, $d_{ij}$, es menor a un cierto umbral para alguna de las combinaciones $\mathbf{p}_i\leftrightarrow \mathbf{p}_j$, $\mathbf{q}_i\leftrightarrow \mathbf{q}_j$, $\mathbf{p}_i\leftrightarrow \mathbf{q}_j$ o $\mathbf{q}_i\leftrightarrow \mathbf{p}_j$. En la primera etapa de la búsqueda se testean todas las posibilidades mientras que en la segunda etapa se testean solo los puntos del segmeneto que no fueron utilizados. Por ejemplo, si se encontró la correspondencia $\mathbf{p}_i\leftrightarrow \mathbf{p}_j$ se busca el $k$-ésimo segmento $\mathbf{s}_k$ que cumple que la distancia euclidiana $d_{ij}$ es menor a cierto umbral para alguna de las combinaciones $\mathbf{q}_i\leftrightarrow \mathbf{p}_k$ y $\mathbf{q}_i\leftrightarrow \mathbf{q}_k$. En la tercer etapa la chequeo se realiza de forma mas aún mas restingida.\\
\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{figs_detection/SegmentosRectas.eps}
\caption{Conjunto de cuadriláteros conexos. A la izquiera el primer paso del filtrado en donde se busca una ``U'', a la derecha el último paso en donde se cierra la ``U''.}
\label{fig:SegmentosRectas}
\end{figure}

Una vez encontrado el conjunto de cuatro segmentos conexos se marcan estos segmentos como utilizados, se guardan en una lista de salida y se continúa con el segmento $i+1$ hasta recorrer los $m$ segmentos de la lista de entrada. De esta forma se obtiene una lista de salida $\mathbf{S}$ de $n$ segmentos en donde $n$ es por construcción múltiplo de cuatro.\\

La condición de vecindad se podría refinar de forma de disminuir el riesgo de tener ``falsos vecinos''. Esta situación se puede dar, por ejemplo, en un grupo de segmentos paralelos cercanos y de tamaño similar o en el caso de detectar cuadrados concéntricos en los que la distancia entre sus lados es inferior al umbral. En el primer caso se puede considerar un condición de vecindad que tome en cuenta la intersección de los segmentos y la distancia de la intersección a los puntos del segmento. De todas formas ninguna de las dos situaciones se hicieron presentes en casos prácticos y la implementación de soluciones no fue necesaria además de que aumentaría levemente la complejidad del algoritmo.
\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{figs_detection/FilterError.eps}
\caption{Posible configuración de segmentos paralelos que ``sobreviven'' al filtrado. A la izquiera el grupo de segmentos, a la derecha se muestra como se cierra el conjunto partiendo de $\mathbf{s}_i$.}
\label{fig:FilterError}
\end{figure}

\subsubsection{Determinación de correspondencias}
\label{subsec:detection_correspondencias}
Se detalla a continuación el algoritmo de determinación de correspondencias a partir de grupos de cuatro segmentos de línea conexos. Para ese algoritmo se hace uso de los elementos estructurales del marcado (sec.: \ref{sec:detection_estructuras}), de forma de desarrollar un algoritmo modular, escalable y simple.

Se toma como entrada la lista de segmentos filtrados
\begin{equation}
\mathbf{S} = \begin{pmatrix}
			 \mathbf{s}_0 & \mathbf{s}_1 & \dots & \mathbf{s}_{i} & \mathbf{s}_{i+1} & \mathbf{s}_{i+2} & \mathbf{s}_{i+3} & \dots & \mathbf{s}_{n-1}
			 \end{pmatrix}^t
\end{equation}
en donde cada segmento se compone de un punto inicial $\mathbf{p}_{i}$ y un punto final $\mathbf{q}_{i}$, $\mathbf{s}_{i} = (\mathbf{p}_{i},\mathbf{q}_{i})$, con $n$ es múltiplo de cuatro. Si $i$ también lo es, entonces el sub-conjunto, 
$\mathbf{S}_i = \begin{pmatrix}
				\mathbf{s}_{i} & \mathbf{s}_{i+1} & \mathbf{s}_{i+2} & \mathbf{s}_{i+3}
				\end{pmatrix}^t$, corresponde a un conjunto de cuatro segmentos del línea conexos.

Para cada sub-conjunto $\mathbf{S}_i$ se intersectan entre sí los segmentos obteniendo una lista de cuatro vértices,
$\mathbf{V}_i =  \begin{pmatrix}
		 \mathbf{v}_{i} & \mathbf{v}_{i+1} & \mathbf{v}_{i+2} & \mathbf{v}_{i+3} 
		 \end{pmatrix}^t$. 
Si  $\mathbf{r}_i$ es la recta que pasa por los puntos $\mathbf{p}_i$ y $\mathbf{q}_i$ del segmento  $\mathbf{s}_i$, la lista de vértices se obtiene como sigue,
\begin{eqnarray}
\mathbf{v}_i = & \mathbf{r}_i\cap \mathbf{r}_{i+1} \nonumber\\
\mathbf{v}_{i+1} = & \mathbf{r}_i\cap \mathbf{r}_{i+2} \nonumber\\
\mathbf{v}_{i+2} = & \mathbf{r}_{i+3}\cap \mathbf{r}_{i+2} \nonumber\\
\mathbf{v}_{i+3} = & \mathbf{r}_{i+3}\cap \mathbf{r}_{i+1} \nonumber
\end{eqnarray}
resultando en dos posibles configuraciones de vértices. Las dos configuraciones se muestran en la figura \ref{fig:Vertices} en donde una de ellas tiene sentido horario y la otra antihorario partiendo de ${v}_i$.
\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{figs_detection/Vertices.eps}
\caption{Posibles configuraciones de vértices posterior a la intersección de conjuntos de segmentos pertenecientes a un cuadrilátero.}
\label{fig:Vertices}
\end{figure}

Posterior a la intersección se realiza un chequeo sobre el valor de las coordenadas de lo vértices. Si alguno de ellos se encuentra fuera de los límites de la imagen, el conjunto de cuatro segmentos es marcado como inválido. Este chequeo resulta en el filtado de ``falsos cuadriláteros'' como por ejemplo un grupo de segmentos paralelos cercanos. 

Para cada uno de los conjuntos de vértices se construye con ellos un elemento \emph{cuadrilátero} que se almacena en una lista de cuadriláteros
\begin{eqnarray*}
 QlList =  \begin{pmatrix}
            \text{Ql}[0] & \text{Ql}[1] & \dots & \text{Ql}[i] & \dots & \text{Ql}[\frac{n}{4}]
           \end{pmatrix}^t
\end{eqnarray*}
% en sentido amplio, de dos segmentos contiguos, $s_i\cap s_{i+1}$ dadas las recta $r_1$ que pasa por los puntos $\mathbf{p}_1$, $\mathbf{q}_1$ del segmento $s_1$ y la recta $r_2$ que pasa por los puntos $\mathbf{p}_2$, $\mathbf{q}_2$ del segmento $s_2$, se determina el vértice correspondiente como la intersección $r_1 \cap r_2$. \\
% 
% y se intersectan en grupos de cuatro obteniendo cuatro vértices por cada grupo. Para cada grupo de vértices $v_k$ se construye un elemento cuadrilátero $\text{Ql}[k]$ que se almacena en una lista de cuadriláteros. 

A partir de esa lista de cuadriláteros, se buscan grupos de tres cuadriláteros $\text{QlSet}$ que ``compartan'' un mismo centro. Para esto se recorre ordenadamente la lista en $i$ buscando para cada cuadrilátero dos cuadriláteros $j$ y $k$ que cumplan que la distancia entre sus centros  y el del $i$-ésimo cuadrilátero sea menor a cierto umbral $d_{th}$,
\begin{equation}
\begin{split}
 d_{ij} = ||\mathbf{c}_i - \mathbf{c}_j||<d_{th}, & \quad  d_{ik} = ||\mathbf{c}_i - \mathbf{c}_k||<d_{th}.
\end{split}
\end{equation}
Estos cuadriláteros se marcan en la lista como utilizados con ellos se forma el $l$-ésimo $QlSet$ ordenándolos según su perímetro, de menor a mayor como  
$$QlSet[l] = \begin{pmatrix} Ql[0] & Ql[1] & Ql[2] \end{pmatrix}$$
con $l = (0,1,2)$. Esta busqueda se realiza hasta encontrar un total de tres $QlSet$ completos de forma de obtener un marcador completo, esto es, detectando todos los cuadriláteros que lo componen. \\

Una vez obtenida la lista de tres $QlSet$, 
$$QlSetList = \begin{pmatrix} QlSet[0] & QlSet[1] & QlSet[2] \end{pmatrix}$$
ésta se ordena de forma que su dispoción espacial se corresponda con la del \emph{marcador QR}. Para esto se calculan las distancias entre los centros de cada $QlSet$ y se toma el índice $i$ como el índice que produce el vector de menor distancia, $\mathbf{u}_i = \mathbf{c}_{i+1} -\mathbf{c}_i$. Una vez seleccionado el vector $\mathbf{u}_i$, se tienen obtiene el juego de vectores $(\mathbf{u}_i,\mathbf{u}_{i+1},\mathbf{u}_{i+2})$ como se muestra en la figura \ref{fig:Centros}.
\begin{figure}[h!]
\centering
\includegraphics[scale=0.45]{figs_detection/Centros.eps}
\caption{Posibles configuraciones de centros resultan en la orientación de los vectores $\mathbf{u}_{i+k}$.}
\label{fig:Centros}
\end{figure}

Existen solo dos posibles configuraciones para estos vectores por lo que se utiliza este conocimiento para ordenar los $QlSet$ de la lista realizando el producto vectorial, aumentando la dimensión de los vectores $\hat{\mathbf{u}_i}$ y $\hat{\mathbf{u}_{i+1}}$ con coordenada $z=0$,
\begin{equation*}
 \mathbf{b} = \hat{\mathbf{u}_i} \times \hat{\mathbf{u}_{i+1}}.
\end{equation*}
Si el vector $\mathbf{b}$ tiene valor en la coordenada $z$ positivo se ordena como,
\begin{eqnarray*}
 QlSet[0]\longleftarrow & QlSet[i]\\
 QlSet[1]\longleftarrow & QlSet[i+2]\\
 QlSet[2]\longleftarrow & QlSet[i+1]
\end{eqnarray*}
o de lo contratio se ordena como,
\begin{eqnarray*}
 QlSet[0]\longleftarrow & QlSet[i+1]\\
 QlSet[1]\longleftarrow & QlSet[i+2]\\
 QlSet[2]\longleftarrow & QlSet[i]
\end{eqnarray*}

Por ultimo se construye un \emph{marcador QR} que contiene la lista de tres $QlSet$ ordenados según lo indicado permitiendo la definición de un centro de coordenadas como el centro $\mathbf{c}_0$ del $QlSet[0]$ y ejes de coordenadas definidos en \ref{ec:detection_ejes}. Los ejes de este sistema de coordenadas permiten, para cada $Ql$ de cada $QlSet$, proyectar los vértices sobre sus ejes y según su signo ordenarlos como se muestra en la figura \ref{fig:VerticesProyectados}.
\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{figs_detection/VerticesProyectados.eps}
\caption{Posibles configuraciones de centros resultan en la orientación de los vectores $\mathbf{u}_{i+k}$.}
\label{fig:VerticesProyectados}
\end{figure}
De esta forma, recorriendo ordenadamente los elementos del marcador, se ordenan los vértices detectados obteniendo una lista de vértices que se corresponde con la lista de vértices del marcador en coordenadas del mundo. 

Se determinan las correspondencias  $\mathbf{M}_i\leftrightarrow \mathbf{m}_i$ necesarias para la estimación de pose.

\subsubsection{Robustificando la detección}
En base al algoritmo de determinación de correspondencias previamente descrito se tienen ciertas limitantes que resultan afectar seriamente la performance de la aplicación. La primera de ellas 

En caso de que no se encuentre ningún $QlSet$ completo se descarta la lista de segmentos y se indica que la determinación de correspondencias falló. Cabe la posibilidad de que los segmentos Debido a posibles oclusionesSi se encuentra un único $QlSet$ c

\subsubsection{Resultados}
Oh sí!

