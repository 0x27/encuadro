\chapter{Filtrado de Kalman para estimación de pose}
\label{chap: kalman}

\section{Introducción}
Luego de obtener la pose de la cámara para un cuadro, se procedió a evaluar el desmpe\~no de la aplicación en tiempo real. Una de las cosas que se notó fue que había un ruido en la estimación. Por ejemplo con el dispositivo quieto se puede ver que la  pose varía. Si bien numéricamente no es mucha la variación, perceptivamente se nota. Es por esto que se decidió implementar un filtro de Kalman para suavizar la estimación.   

Otra razón por la cual se usó el filtro de Kalman fue para realizar fusión de sensores. El dispositivo cuenta con sensores inerciales y es posible obtener la variación en la orientación entre dos cuadros. Esta información se fusionó con la información obtenida de la pose mediante un filtro de Kalman.  

En este capítulo se presenta el filtro de Kalman de forma genérica para luego explicar las implementaciones particulares del caso de Kalman para suavizado y Kalman para fusión de sensores.

\section{Filtro de Kalman}

Sea $\mathbf{x}_k$ un vector de estados de dimensión $n$ que evoluciona de acuerdo a la ecuación
\begin{equation}
 \mathbf{x}_{k+1}=\mathbf{F}_k\mathbf{x}_k + \mathbf{w}_k
\end{equation}
donde $\mathbf{F}_k$ es la matriz de transición de estados de dimensiones $n \times n$ y $\mathbf{w}_k$ es el vector de ruido del proceso, es de tama\~no $n$ y se modela como $\mathbf{w}_k\sim \mathcal{N}(\mathbf{0},\mathbf{Q}_k)$ en donde $\mathbf{Q}_k$ es la matriz de covarianza de tama\~no $n\times n$ \cite{Hayes}. Este ruido sirve para ajustar la confianza que se le tiene al modelo utilizado. Si el modelo utilizado es bueno el ruido de proceso $\mathbf{w}_k$ es chico.

Adicionalmente se tiene el vector de observaciones $\mathbf{y}_k$ formado como 
\begin{equation}
 \mathbf{y}_k=\mathbf{H}_k\mathbf{x}_k + \mathbf{v}_k
\end{equation}
donde $\mathbf{y}_k$ es de largo $m$. $\mathbf{H}_k$ es la matriz de medición, relaciona las observaciones con los estados del proceso, es de tama\~no $m\times m$. $\mathbf{v}_k$ es el vector de ruido en la medición, es de tama\~no $m$ y se modela como $\mathbf{v}_k\sim \mathcal{N}(\mathbf{0},\mathbf{R}_k)$ siendo $\mathbf{R}_k$ la matriz de covarianza de tama\~no $m\times m$.

Se tiene entonces un proceso representado por un modelo en variables de estado como
\begin{equation*}
	\begin{cases}
	\mathbf{x}_{k+1}=\mathbf{F}_k\mathbf{x}_k + \mathbf{w}_k\\
	\mathbf{y}_k=\mathbf{H}_k\mathbf{x}_k + \mathbf{v}_k
	\end{cases}
\end{equation*}

El estado del filtro se representa por dos variables, la estimación del estado \emph{a posteriori} en el instante $k$, $\hat{\mathbf{x}}_{k|k}$, y la matriz de covarianza del error de estimación \emph{a posteriori}, $\mathbf{P}_{k|k}$.

El filtrado parte de una condición inicial $\hat{\mathbf{x}}_{0|0}$ y $\mathbf{P}_{0|0}$. El proceso de filtrado se realiza iterativamente en dos etapas, una de predicción y una de actualización:
\begin{itemize}
\item \textbf{Predicción}
\[ \hat{\mathbf{x}}_{k|k-1} = \mathbf{F}_{k}\hat{\mathbf{x}}_{k-1|k-1} \]
\[ \mathbf{P}_{k|k-1} =  \mathbf{F}_{k} \mathbf{P}_{k-1|k-1} \mathbf{F}_{k}^{\text{T}} + \mathbf{Q}_{k}  \]
\item \textbf{Actualización}
\begin{eqnarray}
	\mathbf{K}_k = &&   \mathbf{P}_{k|k-1}\mathbf{H}_k^\text{T}[\mathbf{H}_k \mathbf{P}_{k|k-1} \mathbf{H}_k^\text{T} + \mathbf{R}_k]^{-1} \nonumber\\
\hat{\mathbf{x}}_{k|k} = &&   \hat{\mathbf{x}}_{k|k-1} + \mathbf{K}_k[\mathbf{y}_k - \mathbf{H}_k\hat{\mathbf{x}}_{k|k-1}] \nonumber\\
	\mathbf{P}_{k|k} = &&   (\mathbf{I} - \mathbf{K}_k \mathbf{H}_k) \mathbf{P}_{k|k-1} \nonumber
\end{eqnarray}
\end{itemize}


\section{Kalman para suavizado}

La información que se obtiene de la etapa de estimación de pose son la orientación de la cámara expresada en ángulos de Euler y la traslación. Se busca suavizar el efecto del ruido introducido al estimar la rotación, este ruido es el que mas influye en la calidad de la realidad aumentada. Los estados son por lo tanto los tres ángulos de Euler, $\psi$, $\theta$ y $\phi$.  

Para implementar el filtro de Kalman es necesario contar con un modelo físico que modele el la evolución de los estados. Como el dispositivo es controlado por una persona, no se puede asumir nada en cuanto al movimiento que va a realizar esta persona. 
Por lo tanto se toma un modelo de posición constante y se asume que los movimientos que se realizan son peque?os. La matriz de evolución de estados \textbf{F} se toma como la matriz identidad. 

La matriz de covarianza del ruido de proceso $\mathbf{Q}_k$ se toma como una matriz diagonal ya que por como se definió el modelo se deduce que el ruido del proceso para cada estado son independientes.

En este caso las observaciones que se tienen coinciden con los tres estados por lo tanto la matriz de medición \textbf{H} se toma como la matriz identidad. 

La matriz de covarianza del ruido de medición se calculó se obtuvo a través de varias mediciones con imágenes sintéticas. Se le  aplico el proceso a varias imágenes y se comparó la orientación obtenida contra la real. A partir de estos datos se computó la matriz \textbf{R}. Se tiene que

\[
\textbf{R} = \left(\begin{array}{ccc}
4.962496 & 4.314506 & -0.045967 \\
4.314506 & 7.023549 & 0.074892 \\
-0.045967 & -0.074892 & 0.001062
\end{array} \right)
\]

Con estos parámetros se implementó el filtro de Kalman para suavizado. 

\section{Kalman con sensores}
Para hacer la fusión de sensores se tomaron los mismos estados, la misma matriz de evolución de estados y el mismo error de proceso. Como observaciones se tienen los ángulos de Euler calculados por POSIT $\left(\psi_C,\theta_C,\phi_C\right)$ y los ángulos de Euler a la salida de los sensores inerciales  $\left(\psi_S,\theta_S,\phi_S\right)$. La ecuación de observaciones de Kalman queda

\[
\left(\begin{array}{c}
\psi_C\\
\theta_C\\
\phi_C\\
\psi_S\\
\theta_S\\
\phi_S
\end{array}\right) =
\left(\begin{array}{ccc}
1 & 0 & 0 \\
0 &1 & 0 \\
0 & 0 & 1 \\
1 & 0 & 0 \\
0 &1 & 0 \\
0 & 0 & 1 \\
\end{array}\right)
\left(\begin{array}{c}
\psi\\
\theta\\
\phi\\
\end{array}\right)+
\left(\begin{array}{cccccc}
4.962496 & 4.314506 & -0.045967 & 0 & 0 & 0 \\
4.314506 & 7.023549 & 0.074892 & 0 & 0 & 0  \\
-0.045967 & -0.074892 & 0.001062 & 0 & 0 & 0 \\
0 & 0 & 0 & 1 & 0 & 0\\ 
0 & 0 & 0 & 0 & 1 & 0\\ 
0 & 0 & 0 & 0 & 0 & 1\\ 
\end{array} \right)
\]  
La matriz de error de medición es una matriz de bloques diagonal compuesta por la matriz de covarianza del error de medición de POSIT y por la matriz de covarianza del error de medición de los sensores. Es razonable tomar la matriz covarianza como diagonal ya que esto implica que el error de medición de  POSIT es independiente de el de los sensores. Para los sensores no se contó con ninguna estadistica que permitiera calcular la matriz de covarianza, esto es un aspecto a mejorar.  
%\section{Kalman robusto}

\section{Resultados}
